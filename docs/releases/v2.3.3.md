# Release Notes v2.3.3

**Release Date:** 2025-11-10  
**Type:** Feature Release

## üöÄ Major Changes

### File Completeness Check

**Problem:** Files that are already extracted (e.g., MKV files from TV shows) were being processed immediately, even if they were still downloading. This caused issues with files that take hours or days to download with long pauses between download sessions.

**Solution:** 
- Files must be unchanged for a configurable period (default: 24 hours) before being processed
- File size is tracked across runs in the database
- Files are only processed if:
  1. File size hasn't changed since last check
  2. File hasn't been modified for the configured stability hours

**Impact:** 
- Prevents processing of incomplete files
- Handles long downloads with pauses (e.g., 19 hours with multiple hour-long pauses)
- Works for all file types, not just archives
- Configurable stability period (1-168 hours)

## üéØ Improvements

### File Stability Hours Setting

**New Setting:** "File Stability Hours" in WebGUI Settings ‚Üí File Processing

**Default:** 24 hours

**Range:** 1-168 hours (7 days)

**Usage:** 
- Configure how long a file must be unchanged before processing
- Higher values = more conservative (wait longer)
- Lower values = more aggressive (process sooner)

**Example Use Cases:**
- Large files (20GB+) with long download times: 24-48 hours
- Normal files: 12-24 hours
- Fast downloads: 1-6 hours

## üîß Technical Details

### Database Schema

New table added to `cineripr_settings.db`:

**`file_status` table:**
- `file_path` (TEXT PRIMARY KEY) - Full path to the file
- `file_size` (INTEGER) - File size in bytes
- `last_check` (TIMESTAMP) - Last time the file was checked

### New Function

**`is_file_complete(file_path, db, stability_hours)`** in `src/cineripr/core/file_operations.py`:
- Checks if file size matches previous run
- Checks if file hasn't been modified recently
- Returns `True` if file is complete, `False` if still downloading

### Integration

- `process_downloads()` in `src/cineripr/core/archives.py` now checks file completeness before processing
- Only applies to directories without archives (already extracted files)
- Files are skipped if not complete, with a log message

## üêõ Bug Fixes

### Import Errors Fixed

**Issue:** Import errors occurred when importing `archive_constants` from wrong module.

**Fixed:**
- `src/cineripr/core/archives.py`: Changed `from .archive_constants` ‚Üí `from ..extraction.archive_constants` (3 locations)
- `src/cineripr/core/file_operations.py`: Changed `from .archive_constants` ‚Üí `from ..extraction.archive_constants` (3 locations)

## üìã Migration Guide

### No Migration Required

This release is fully backward compatible. No migration steps are required.

### New Default Behavior

- Files that are already extracted (non-archive files) are now checked for completeness
- Default stability period is 24 hours
- Files are skipped if they appear to be still downloading

### Configuration

To adjust the stability period:
1. Open WebGUI
2. Go to Settings ‚Üí File Processing
3. Set "File Stability Hours" (1-168 hours)
4. Click "Save All Settings"

## üéØ Use Cases

### TV Show Episodes (MKV Files)

**Scenario:** TV show episodes are downloaded as already-extracted MKV files with long pauses between download sessions.

**Solution:** Set "File Stability Hours" to 24 hours (default). Files will only be processed after being unchanged for 24 hours.

### Large Movie Files

**Scenario:** Large movie files (20GB+) take 19 hours to download with multiple hour-long pauses.

**Solution:** Set "File Stability Hours" to 24-48 hours to ensure files are fully downloaded before processing.

### Fast Downloads

**Scenario:** Files download quickly without long pauses.

**Solution:** Set "File Stability Hours" to 1-6 hours for faster processing.

## üîç Testing

### Test Scenarios

1. **File Still Downloading:**** File size changes between runs ‚Üí File is skipped
2. **File Complete:** File size unchanged for 24+ hours ‚Üí File is processed
3. **File Recently Modified:** File size unchanged but modified < 24 hours ago ‚Üí File is skipped
4. **First Time Seeing File:** File is new ‚Üí File is skipped (saved for next run)

## üìù Notes

- File status is persisted in the database, so checks work across Docker restarts
- Only applies to directories without archives (already extracted files)
- Archive files are processed immediately (they are complete when all parts are present)
- The stability check is conservative by default (24 hours) to prevent processing incomplete files

