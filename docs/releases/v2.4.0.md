# Release Notes v2.4.0

**Release Date:** 2025-11-10  
**Type:** Feature Release + Critical Bug Fixes

## ğŸš€ Major Features

### 1. Additional Statistics (Extracted, Copied, Moved)

**New Counters:**
```
ğŸ“¦ Extracted: Number of archive files extracted
ğŸ“„ Copied: Number of files copied (from non-archive releases)
â¡ï¸ Moved: Number of archive files moved to finished folder
```

**Benefits:**
- More granular insight into processing operations
- Track individual file operations, not just archive counts
- All statistics persisted to database
- Real-time updates in WebGUI

**Technical:**
- Added `extracted_count`, `copied_count`, `moved_count` to `GlobalStatus` dataclass
- Tracking happens at file operation level:
  - `increment_extracted()` called after each successful extraction
  - `increment_copied()` called after each file copy
  - `increment_moved()` called after each file move

### 2. File Stability Bug Fixed (CRITICAL)

**Problem:**
Files were being moved to `_finished` even though they were still downloading and not copied to `_extracted`.

**Root Cause:**
```python
# Before (BUG):
if not is_file_complete(entry, db, stability_hours):
    continue  # File not copied
files_to_move.append((current_dir, release_name))  # âŒ Always executed!

# After (FIXED):
if not is_file_complete(entry, db, stability_hours):
    continue  # File not copied
if files_to_copy:  # âœ… Only if files were actually copied
    files_to_move.append((current_dir, release_name))
```

**Impact:**
- âœ… Files < 24h are kept in downloads folder until stable
- âœ… `_extracted` folder is populated correctly
- âœ… `file_stability_hours` setting is now respected
- âœ… No more data loss from premature moves

### 3. Parallel Extraction Infrastructure

**Settings Added:**
- `parallel_extractions`: Number of releases to process simultaneously (default: 1)
- `cpu_cores_per_extraction`: CPU cores per extraction (default: 2)

**Current Status:**
- âš ï¸ Parameters are defined and passed through the call chain
- âš ï¸ Currently processes **sequentially only** (parallel_extractions = 1)
- âš ï¸ True parallelization requires major refactoring of:
  - Logging (thread-safe)
  - Status tracking (thread-safe)
  - Progress bars (per-thread)
  - Error handling (aggregation)

**Why Not Implemented?**
Parallelization on release-level requires significant architectural changes. The infrastructure is in place for future implementation.

**Settings in WebGUI:**
- Visible in Settings > Performance
- Can be configured but currently have no effect
- Reserved for future use

## ğŸ› Bug Fixes

### Critical Bugs

1. **File Stability Ignored**
   - **Symptom:** Files moved to `_finished` despite being < 24h old
   - **Cause:** `files_to_move.append()` executed unconditionally
   - **Fix:** Added `if files_to_copy:` condition

2. **Empty `_extracted` Folder**
   - **Symptom:** Files not copied to `_extracted`, but source moved to `_finished`
   - **Cause:** Same as above - premature move
   - **Fix:** Same as above

## ğŸ“‹ Migration Guide

### Automatic Migration

No manual migration required. Changes are backward compatible.

### What to Expect

**Statistics:**
- Old statistics (Processed, Failed, Unsupported, Deleted) remain unchanged
- New statistics (Extracted, Copied, Moved) start at 0
- Will increment as new operations occur

**File Stability:**
- Files that were previously moved prematurely will NOT be recovered
- Future files will be handled correctly
- Check `_finished` folder for incomplete files and move back manually if needed

**Parallel Extraction:**
- Settings visible in WebGUI but have no effect
- Default value (1) means sequential processing
- Changing values is safe but does nothing

## ğŸ” Verification

### Verify Statistics

1. Process a release with archives:
   ```
   âœ“ Processed: +1 (archive count)
   ğŸ“¦ Extracted: +X (number of archive parts)
   â¡ï¸ Moved: +X (archive parts moved)
   ```

2. Process a release with non-archive files:
   ```
   ğŸ“„ Copied: +X (number of files)
   â¡ï¸ Moved: +X (files moved to finished)
   ```

### Verify File Stability

1. Download a large MKV file (still downloading)
2. Wait for CineRipR to scan
3. Check logs:
   ```
   [INFO] File Show.S03E01.mkv appears to be still downloading, skipping...
   ```
4. File should remain in `downloads` folder
5. After 24h (or configured hours), file will be processed

### Verify Empty `_extracted` Fixed

1. Before fix: `_extracted` was empty, `_finished` had raw downloads
2. After fix: `_extracted` has copied/extracted files, `_finished` has source archives

## ğŸ¯ Performance Impact

- **No measurable performance impact** for statistics tracking
- Parallel extraction infrastructure adds minimal overhead (parameter passing)
- File stability check already existed, bug fix has no performance impact

## ğŸ“ Notes

### Parallel Extraction

The parallel extraction feature was **discussed and settings were added**, but **not implemented** due to:

1. **Complexity:** Requires thread-safe refactoring of logging, status tracking, progress bars
2. **Risk:** High risk of race conditions and data corruption
3. **Testing:** Requires extensive testing across different scenarios

**Future Plans:**
- Refactor logging to be thread-safe
- Implement per-thread progress tracking
- Add release-level locking
- Extensive testing with multiple parallel extractions

Until then, the settings exist but processing remains sequential.

### Breaking Changes

**None.** This release is fully backward compatible.

### Deprecations

**None.**

## ğŸ”— Related Issues

- File Stability Bug: Reported by user during TV show download
- Statistics Request: User explicitly requested "Extrahiert, Kopiert, Verschoben"
- Parallel Extraction: Discussed as "Option 1: Hybrid Approach" but not yet implemented

## ğŸ“š Documentation Updates

- Updated `CHANGELOG.md` with v2.4.0 changes
- Updated `docs/README.md` to reference v2.4.0
- Updated `PROJECT_STATUS.md` with latest version
- Created `docs/releases/v2.4.0.md` (this file)
- Added inline code comments explaining parallel extraction infrastructure

## âš ï¸ Important Notes

1. **Parallel Extraction:** Settings are visible but have no effect. This is intentional and documented.
2. **File Stability:** Only applies to **non-archive files** (e.g., MKV). Archives are processed immediately.
3. **Statistics:** New counters start at 0 and increment from this version forward.

