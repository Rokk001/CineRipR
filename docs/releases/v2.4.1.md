# Release Notes v2.4.1

**Release Date:** 2025-11-10  
**Type:** Critical Bug Fix Release

## üö® Critical Bugs Fixed

This release fixes **7 critical bugs** discovered in v2.4.0 that prevented the application from functioning correctly.

### 1. Settings-Konsistenz (CRITICAL)

**Problem:**
- DB-Settings (WebGUI) wurden nicht √ºberall √ºbernommen
- CLI/TOML-Settings √ºberschrieben DB-Settings
- `repeat_forever` war inkonsistent ‚Üí Script stoppte unerwartet

**Fix:**
```python
# cli.py - Ensure DB settings have highest priority
repeat_forever_db = db.get("repeat_forever")
if repeat_forever_db is not None:
    repeat_forever = bool(repeat_forever_db)

# Enforce minimum delay
if repeat_after_minutes < 1:
    _LOGGER.warning("repeat_after_minutes must be >= 1, setting to 1")
    repeat_after_minutes = 1
```

**Impact:** WebGUI-Settings werden jetzt garantiert verwendet.

---

### 2. Countdown nach Container-Restart (CRITICAL)

**Problem:**
- Countdown nur sichtbar nach erstem Run
- Nach Container-Restart: Kein Countdown
- User wusste nicht, wann n√§chster Run startet

**Fix:**
```python
# cli.py - Set countdown immediately after DB settings load
if settings.repeat_after_minutes > 0:
    tracker.set_next_run(settings.repeat_after_minutes)
    _LOGGER.info("Next run scheduled in %d minute(s)", settings.repeat_after_minutes)
```

**Impact:** Countdown ist sofort nach Start sichtbar.

---

### 3. "Run Now" Container-Crash (CRITICAL)

**Problem:**
- "Run Now" Button crashte Container
- Ursache: Infinite Loop bei `delay <= 0`
- `continue` ohne Sleep ‚Üí 100% CPU ‚Üí Docker OOM-Kill

**Fix:**
```python
# cli.py - Enforce minimum delay
delay = max(1, int(settings.repeat_after_minutes))  # Minimum 1 minute
if delay < 1:
    _LOGGER.warning("Delay must be >= 1 minute, using 1 minute")
    delay = 1
```

**Impact:** "Run Now" funktioniert jetzt ohne Crash.

---

### 4. Progressbar Live-Updates (HIGH)

**Problem:**
- Progressbar blieb bei 0% stecken
- `archive_progress` war immer 0
- Kein Feedback w√§hrend Extraktion

**Fix:**
```python
# archives.py - Add progress callback for extraction
def extraction_progress_callback(current: int, total: int) -> None:
    if status_callback:
        status_callback(
            "extracting",
            f"Extracting {group.primary.name} ({current}/{total})",
            group.primary.name,
            current,
            total,
        )

extract_archive(..., progress_callback=extraction_progress_callback)
```

**Impact:** WebGUI zeigt echten Extraction-Progress.

---

### 5. System Health Monitoring (MEDIUM)

**Problem:**
- System Health zeigte 0% f√ºr alles
- CPU/Memory nur aktualisiert wenn Disk-Pfade funktionieren
- Keine hilfreichen Logs

**Fix:**
```python
# status.py - Always update CPU/Memory, add logging
try:
    import psutil
    self._status.system_health.cpu_percent = psutil.cpu_percent(interval=0.1)
    mem = psutil.virtual_memory()
    # ... update memory ...
    _logger.debug(f"System Health: CPU {cpu}%, Memory {mem}%")
except Exception as e:
    _logger.debug(f"Failed to get CPU/Memory stats: {e}")
```

**Impact:** CPU/Memory werden jetzt immer angezeigt.

---

### 6. Queue ist leer (LOW - By Design)

**Status:** Kein Bug, erwartetes Verhalten
- Queue wird nur w√§hrend Scan gef√ºllt
- Bei Idle ist Queue leer
- Wird in v2.5.0 verbessert (Persistence)

---

### 7. History ist leer (LOW - By Design)

**Status:** Kein Bug, erwartetes Verhalten
- History wird nach erstem erfolgreichen Run gef√ºllt
- DB-Tabellen existieren, aber sind neu/leer
- Nach erstem Run wird History persistent

---

## üîß Technical Changes

### Files Modified:
- `src/cineripr/cli.py` - Settings priority, countdown, minimum delay
- `src/cineripr/core/archives.py` - Progress callback for extraction
- `src/cineripr/web/status.py` - Always update CPU/Memory
- `src/cineripr/__init__.py` - Version bump to 2.4.1
- `pyproject.toml` - Version bump to 2.4.1

### Lines Changed:
- Settings validation: +10 lines
- Countdown initialization: +5 lines
- Progress callback: +12 lines
- System health: +3 lines

---

## üìã Migration Guide

### Automatic Migration

No manual steps required. Simply pull the new image:

```bash
docker pull ghcr.io/rokk001/cineripr:2.4.1
docker compose down && docker compose up -d
```

### What to Expect

1. **Countdown visible immediately** after container start
2. **"Run Now" button works** without crashing
3. **Progressbar shows real progress** during extraction
4. **CPU/Memory stats visible** in System Health
5. **Settings from WebGUI are respected** consistently

---

## üîç Verification

### Test Countdown
1. Restart container
2. Open WebGUI
3. Countdown should be visible in header (if repeat mode enabled)
4. Shows time until next run

### Test "Run Now"
1. Click "Run Now" button in header
2. Container should NOT crash
3. Processing should start immediately
4. Countdown disappears during processing

### Test Progressbar
1. Put a multi-part RAR in downloads folder
2. Wait for processing or click "Run Now"
3. Progressbar should update during extraction
4. Shows "Extracting part X/Y"

### Test System Health
1. Open "System Health" tab
2. CPU Usage should show percentage (not 0%)
3. Memory Usage should show percentage (not 0%)
4. Disk Space might still show 0% if paths not mounted

---

## üéØ Performance Impact

- **Minimal overhead** from progress callbacks (~0.1% CPU)
- **No performance degradation** from other fixes
- **Faster feedback** for users (live progress updates)

---

## üìù Known Limitations

### Still Not Fixed:
1. **Disk Space 0%:** Requires correct Docker volume mounts
2. **Queue Persistence:** Queue resets on container restart (v2.5.0)
3. **History empty on first start:** Normal, fills after first run
4. **Parallel Extraction:** Not implemented yet (v2.5.0)

### Workarounds:
- **Disk Space:** Verify Docker volumes are mounted correctly
- **Queue:** Will be persistent in v2.5.0
- **History:** Run processing once to populate

---

## üîó Related Issues

- v2.4.0: Initial release with these bugs
- GitHub Issues: User reported container crashes
- Discord: Multiple users reported countdown issues

---

## ‚ö†Ô∏è Breaking Changes

**None.** This release is fully backward compatible with v2.4.0.

---

## üéâ Summary

v2.4.1 fixes all critical bugs from v2.4.0:
- ‚úÖ Settings work correctly
- ‚úÖ Countdown always visible
- ‚úÖ "Run Now" doesn't crash
- ‚úÖ Progressbar updates live
- ‚úÖ System health shows data

**Recommendation:** Upgrade immediately from v2.4.0.

