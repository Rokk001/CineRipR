# Release Notes: CineRipR v2.5.1

**Release Date:** November 10, 2025  
**Type:** Hotfix Release  
**Priority:** **CRITICAL** - Contains crash fix

---

## üö® Critical Fixes

This release fixes **4 critical bugs** reported by users:

### 1. **Container Crash: CompletedProcess Error** üî•

**Symptom:**
```
[ERROR] Unexpected error in main loop: 'CompletedProcess' object has no attribute 'processed'
```

**Root Cause:** Variable shadowing in `cli.py` - subprocess results were stored in a variable named `result`, which shadowed the `ProcessResult` object from `process_downloads()`.

**Fix:** Renamed all subprocess result variables from `result` ‚Üí `proc_result` (4 occurrences).

**Impact:** This bug caused the main processing loop to crash unexpectedly. **Container could become unresponsive.**

---

### 2. **Countdown Missing After Restart** ‚è±Ô∏è

**Symptom:** After container restart, WebGUI shows "Idle (Manual Mode)" even though repeat mode is enabled.

**Root Cause:** If `repeat_after_minutes` was 0 or invalid, `set_next_run()` was never called, leaving the countdown invisible.

**Fix:**
- Added fallback: If `repeat_forever` is True but `repeat_after_minutes` is invalid (‚â§ 0), use default 30 minutes
- Added debug logging for settings detection
- Enhanced initialization logic

**Impact:** Countdown now **always visible** when repeat mode is enabled, even after restart or with corrupted settings.

---

### 3. **Disk Space/System Health Empty** üíæ

**Symptom:** "System Health" section in WebGUI shows empty values (0%, Unknown, no CPU/Memory data).

**Root Cause:** System health was only updated:
1. Once at startup
2. Periodically during the sleep loop between runs

In manual mode or during long runs, no updates occurred.

**Fix:** Implemented **background health monitor thread**:
- Runs continuously (daemon thread)
- Updates every 30 seconds
- Independent of main processing loop
- Updates disk space, CPU, memory, 7-Zip version

**Impact:** System health metrics now **always up-to-date**, regardless of processing state.

---

### 4. **Queue Empty After Restart** üìã

**Symptom:** Queue tab shows empty list after container restart, even though processing had occurred.

**Root Cause:** Queue was only populated during active `process_downloads()` runs and was not persisted to the database.

**Fix:** Added database persistence:
- New `queue` table in SQLite
- `save_queue()` and `load_queue()` methods
- Auto-save on every queue operation
- Auto-load on startup

**Impact:** Queue now **persists across restarts** and shows pending/completed releases.

---

## üîß Technical Details

### Modified Files

1. **`src/cineripr/__init__.py`**
   - Version bump: `2.5.0` ‚Üí `2.5.1`

2. **`src/cineripr/cli.py`**
   - Added imports: `threading`, `time`, `re`, `subprocess`
   - Added background health monitor thread (lines 398-444)
   - Enhanced countdown initialization with fallback (lines 385-396)
   - Fixed variable shadowing: `result` ‚Üí `proc_result` (4 locations)

3. **`src/cineripr/web/settings_db.py`**
   - Added `queue` table (lines 103-113)
   - Added `save_queue()` method (lines 400-417)
   - Added `load_queue()` method (lines 419-440)

4. **`src/cineripr/web/status.py`**
   - Load queue from DB on startup (lines 277-289)
   - Added `_save_queue_to_db()` helper (lines 555-574)
   - Auto-save queue on add/update/remove/clear operations

5. **`pyproject.toml`**
   - Version bump: `2.5.0` ‚Üí `2.5.1`

---

## üìä Database Schema Changes

### New Table: `queue`

```sql
CREATE TABLE IF NOT EXISTS queue (
    id TEXT PRIMARY KEY,
    status TEXT NOT NULL,
    archive_count INTEGER DEFAULT 0,
    error TEXT,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**Migration:** Auto-created on first run. No manual action required.

---

## üß™ Testing

All 4 bugs have been verified fixed:

| Bug | Status | Test Case |
|-----|--------|-----------|
| CompletedProcess | ‚úÖ Fixed | Main loop runs without crashes |
| Countdown Missing | ‚úÖ Fixed | Countdown visible after restart with repeat mode |
| Disk Space Empty | ‚úÖ Fixed | System health updates every 30s |
| Queue Empty | ‚úÖ Fixed | Queue persists across restarts |

---

## üöÄ Upgrade Path

### Docker (Recommended)

```bash
docker pull ghcr.io/rokk001/cineripr:2.5.1
docker compose up -d
```

### Manual

```bash
git pull origin main
git checkout v2.5.1
pip install -e .
```

---

## üìù Notes

- **Database Migration:** Automatic (new `queue` table created on startup)
- **Configuration:** No changes required
- **Breaking Changes:** None
- **Rollback:** Safe to rollback to v2.5.0 if needed (queue persistence will be lost)

---

## üôè Credits

Special thanks to the user who reported all 4 bugs with detailed error messages and screenshots!

---

## üîó Links

- [Full Changelog](../../CHANGELOG.md#251---2025-11-10)
- [GitHub Repository](https://github.com/Rokk001/CineRipR)
- [Docker Hub](https://ghcr.io/rokk001/cineripr)
- [Documentation](../../docs/README.md)

