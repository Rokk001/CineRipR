# ğŸ”¥ Release v2.4.2 - Critical Countdown Fix

**Released:** 2025-11-10

## ğŸ› Critical Fix

### **Problem: Countdown Missing After Fresh Install**

**Symptom:**
- WebGUI zeigte **KEINEN COUNTDOWN** nach Fresh Install / Container-Restart
- Status: "Idle" ohne Information wann nÃ¤chster Run kommt
- Settings-Tab zeigte "30 Minuten" aber Countdown blieb unsichtbar

**Root Cause:**
```python
# cli.py (VORHER - BROKEN)
repeat_after_minutes_db = db.get("repeat_after_minutes")  # Returns None if key doesn't exist
if repeat_after_minutes_db is not None:  # Never True for fresh DB!
    repeat_after_minutes = int(repeat_after_minutes_db)

# Result: repeat_after_minutes = 0 â†’ Countdown nie gesetzt
```

**Fix:**
```python
# cli.py (JETZT - FIXED)
db_settings = db.load_all_settings()  # Uses DEFAULT_SETTINGS automatically
repeat_after_minutes = int(db_settings.get("repeat_after_minutes", 30))  # Always has value!

# Result: repeat_after_minutes = 30 â†’ Countdown wird gesetzt âœ…
```

---

## âœ… What's Fixed

1. **Countdown Always Visible**
   - Fresh Install: Countdown mit 30 Minuten (Default)
   - Container-Restart: Countdown mit gespeichertem Wert
   - Settings-Ã„nderung: Countdown aktualisiert sich sofort

2. **All Settings Have Proper Defaults**
   - `repeat_after_minutes: 30`
   - `finished_retention_days: 15`
   - `file_stability_hours: 24`
   - `include_sub: true`
   - Alle WebGUI-Settings funktionieren jetzt out-of-the-box

3. **Simplified Code**
   - Vorher: 54 Zeilen mit einzelnen `db.get()` Calls
   - Jetzt: 31 Zeilen mit `db.load_all_settings()`
   - Weniger FehleranfÃ¤llig, einfacher zu warten

---

## ğŸ“¦ Docker Deployment

```bash
docker pull ghcr.io/rokk001/cineripr:2.4.2
docker pull ghcr.io/rokk001/cineripr:latest
```

**docker-compose.yml:**
```yaml
services:
  cineripr:
    image: ghcr.io/rokk001/cineripr:2.4.2
    # ... rest of config
```

---

## ğŸ”„ Migration from v2.4.1

**NO BREAKING CHANGES!**

Simply pull new image and restart:
```bash
docker compose pull
docker compose up -d
```

**After Restart:**
- Countdown should be **immediately visible** in header
- If not: Check Settings-Tab â†’ "Scheduling" â†’ "Repeat After Minutes" should be 30
- If still issues: Delete `/config/cineripr.db` and restart (will recreate with defaults)

---

## ğŸ§ª Testing

To verify the fix works:

1. **Fresh Install Test:**
   ```bash
   docker run --rm -p 8080:8080 ghcr.io/rokk001/cineripr:2.4.2
   ```
   â†’ Open http://localhost:8080
   â†’ Countdown should show "Next: 30:00" (or current time)

2. **Container Restart Test:**
   ```bash
   docker compose restart cineripr
   ```
   â†’ Countdown should reappear after ~5 seconds

3. **Settings Change Test:**
   - Open Settings â†’ Scheduling â†’ Change "Repeat After Minutes" to 60
   - Save â†’ Countdown should update to show 60 minutes

---

## ğŸ“‹ Technical Details

### Changed Files

- `src/cineripr/cli.py` (Lines 229-264)
  - Replaced individual `db.get()` calls with `db.load_all_settings()`
  - Added `DEFAULT_SETTINGS` import for fallback values
  - Ensures all settings have proper defaults from `settings_db.py`

- `src/cineripr/__init__.py`
  - Version bump: `2.4.1` â†’ `2.4.2`

- `pyproject.toml`
  - Version bump: `2.4.1` â†’ `2.4.2`

- `CHANGELOG.md`
  - Added v2.4.2 entry with detailed fix description

### Code Diff

```diff
- # Override with WebGUI settings if they exist
- repeat_forever_db = db.get("repeat_forever")
- if repeat_forever_db is not None:
-     repeat_forever = bool(repeat_forever_db)
- 
- repeat_after_minutes_db = db.get("repeat_after_minutes")
- if repeat_after_minutes_db is not None:
-     repeat_after_minutes = int(repeat_after_minutes_db)
+ # Load all settings with defaults applied automatically
+ db_settings = db.load_all_settings()
+ 
+ # Override with WebGUI settings (with defaults already applied)
+ repeat_forever = bool(db_settings.get("repeat_forever", repeat_forever))
+ repeat_after_minutes = int(db_settings.get("repeat_after_minutes", 30))
```

---

## ğŸ™ User Feedback

This fix was implemented after extensive debugging with the user who reported:
- "wo ist der kack countdown? warum wurde dieser nicht implementiert?"
- "ich sehe noch immer keinen blÃ¶den countdown bis zum nÃ¤chsten automatischen run"

**Result:** Problem identified and fixed in v2.4.2! ğŸ‰

---

## ğŸ“š Related Issues

- v2.4.1: Initial countdown implementation after container restart
- v2.3.2: DB persistence for statistics & history
- v2.1.0: WebGUI config & live countdown feature

---

## ğŸ”— Links

- **GitHub:** https://github.com/Rokk001/CineRipR
- **Docker Hub:** https://ghcr.io/rokk001/cineripr
- **Documentation:** `docs/README.md`

